/* jQuery.couch.js */
(function(g){function s(b){var d=b.split("/");if(d[0]=="_design"){d.shift();return"_design/"+encodeURIComponent(d.join("/"))}return encodeURIComponent(b)}function v(b,d){if(typeof hex_sha1=="undefined")alert("creating a user doc requires sha1.js to be loaded in the page");else{b._id=b._id||"org.couchdb.user:"+b.name;if(d){b.salt=g.couch.newUUID();b.password_sha=hex_sha1(d+b.salt)}b.type="user";if(!b.roles)b.roles=[];return b}}function k(b,d,e,i){d=g.extend({successStatus:200},d);i=g.extend({contentType:"application/json"},
i);e=e||"Unknown error";g.ajax(g.extend(g.extend({type:"GET",dataType:"json",cache:!g.browser.msie,beforeSend:function(a){if(i&&i.headers)for(var c in i.headers)a.setRequestHeader(c,i.headers[c])},complete:function(a){try{var c=r(a,"json")}catch(f){d.error?d.error(a.status,a,f):alert(e+": "+f);return}d.ajaxStart&&d.ajaxStart(c);if(a.status==d.successStatus){d.beforeSuccess&&d.beforeSuccess(a,c);d.success&&d.success(c)}else d.error?d.error(a.status,c&&c.error||e,c&&c.reason||"no response"):alert(e+
": "+c.reason)}},b),i))}function u(b){b=b||{};if(typeof b.ensure_full_commit!=="undefined"){var d=b.ensure_full_commit;delete b.ensure_full_commit;return function(e){e.setRequestHeader("Accept","application/json");e.setRequestHeader("X-Couch-Full-Commit",d.toString())}}}function m(b){var d=[];if(typeof b==="object"&&b!==null)for(var e in b)if(!(g.inArray(e,["error","success","beforeSuccess","ajaxStart"])>=0)){var i=b[e];if(g.inArray(e,["key","startkey","endkey"])>=0)i=p(i);d.push(encodeURIComponent(e)+
"="+encodeURIComponent(i))}return d.length?"?"+d.join("&"):""}function p(b){return b!==null?JSON.stringify(b):null}g.couch=g.couch||{};var t=[];g.extend(g.couch,{urlPrefix:"",activeTasks:function(b){k({url:this.urlPrefix+"/_active_tasks"},b,"Active task status could not be retrieved")},allDbs:function(b){k({url:this.urlPrefix+"/_all_dbs"},b,"An error occurred retrieving the list of all databases")},config:function(b,d,e,i){var a={url:this.urlPrefix+"/_config/"};if(d){a.url+=encodeURIComponent(d)+
"/";if(e)a.url+=encodeURIComponent(e)}if(i===null)a.type="DELETE";else if(i!==undefined){a.type="PUT";a.data=p(i);a.contentType="application/json";a.processData=false}k(a,b,"An error occurred retrieving/updating the server configuration")},session:function(b){b=b||{};g.ajax({type:"GET",url:this.urlPrefix+"/_session",beforeSend:function(d){d.setRequestHeader("Accept","application/json")},complete:function(d){var e=r(d,"json");if(d.status==200)b.success&&b.success(e);else b.error?b.error(d.status,e.error,
e.reason):alert("An error occurred getting session info: "+e.reason)}})},userDb:function(b){g.couch.session({success:function(d){d=g.couch.db(d.info.authentication_db);b(d)}})},signup:function(b,d,e){e=e||{};b=v(b,d);g.couch.userDb(function(i){i.saveDoc(b,e)})},login:function(b){b=b||{};g.ajax({type:"POST",url:this.urlPrefix+"/_session",dataType:"json",data:{name:b.name,password:b.password},beforeSend:function(d){d.setRequestHeader("Accept","application/json")},complete:function(d){var e=r(d,"json");
if(d.status==200)b.success&&b.success(e);else b.error?b.error(d.status,e.error,e.reason):alert("An error occurred logging in: "+e.reason)}})},logout:function(b){b=b||{};g.ajax({type:"DELETE",url:this.urlPrefix+"/_session",dataType:"json",username:"_",password:"_",beforeSend:function(d){d.setRequestHeader("Accept","application/json")},complete:function(d){var e=r(d,"json");if(d.status==200)b.success&&b.success(e);else b.error?b.error(d.status,e.error,e.reason):alert("An error occurred logging out: "+
e.reason)}})},db:function(b,d){function e(a){if(a._id&&a._rev&&i[a._id]&&i[a._id].rev==a._rev)if(typeof Base64=="undefined"){alert("please include /_utils/script/base64.js in the page for base64 support");return false}else{a._attachments=a._attachments||{};a._attachments["rev-"+a._rev.split("-")[0]]={content_type:"application/json",data:Base64.encode(i[a._id].raw)};return true}}d=d||{};var i={};return{name:b,uri:this.urlPrefix+"/"+encodeURIComponent(b)+"/",compact:function(a){g.extend(a,{successStatus:202});
k({type:"POST",url:this.uri+"_compact",data:"",processData:false},a,"The database could not be compacted")},viewCleanup:function(a){g.extend(a,{successStatus:202});k({type:"POST",url:this.uri+"_view_cleanup",data:"",processData:false},a,"The views could not be cleaned up")},compactView:function(a,c){g.extend(c,{successStatus:202});k({type:"POST",url:this.uri+"_compact/"+a,data:"",processData:false},c,"The view could not be compacted")},create:function(a){g.extend(a,{successStatus:201});k({type:"PUT",
url:this.uri,contentType:"application/json",data:"",processData:false},a,"The database could not be created")},drop:function(a){k({type:"DELETE",url:this.uri},a,"The database could not be deleted")},info:function(a){k({url:this.uri},a,"Database information could not be retrieved")},changes:function(a,c){function f(l){g.each(q,function(){this(l)})}function h(){var l=g.extend({heartbeat:1E4},c,{feed:"longpoll",since:a});k({url:n.uri+"_changes"+m(l)},c,"Error connecting to "+n.uri+"/_changes.")}c=c||
{};var j=100,n=this,o=true,q=[];c.success=function(l){j=100;if(o){a=l.last_seq;f(l);h()}};c.error=function(){if(o){setTimeout(h,j);j*=2}};a?h():n.info({success:function(l){a=l.update_seq;h()}});return{onChange:function(l){q.push(l)},stop:function(){o=false}}},allDocs:function(a){var c="GET",f=null;if(a.keys){c="POST";f=a.keys;delete a.keys;f=p({keys:f})}k({type:c,data:f,url:this.uri+"_all_docs"+m(a)},a,"An error occurred retrieving a list of all documents")},allDesignDocs:function(a){this.allDocs(g.extend({startkey:"_design",
endkey:"_design0"},a))},allApps:function(a){a=a||{};var c=this;a.eachApp?this.allDesignDocs({success:function(f){g.each(f.rows,function(){c.openDoc(this.id,{success:function(h){var j,n,o=h._id.split("/");o.shift();o=o.join("/");if(j=h.couchapp&&h.couchapp.index)n=["",b,h._id,j].join("/");else if(h._attachments&&h._attachments["index.html"])n=["",b,h._id,"index.html"].join("/");n&&a.eachApp(o,n,h)}})})}}):alert("Please provide an eachApp function for allApps()")},openDoc:function(a,c,f){c=c||{};d.attachPrevRev||
c.attachPrevRev?g.extend(c,{beforeSuccess:function(h,j){i[j._id]={rev:j._rev,raw:h.responseText}}}):g.extend(c,{beforeSuccess:function(h,j){if(j["jquery.couch.attachPrevRev"])i[j._id]={rev:j._rev,raw:h.responseText}}});k({url:this.uri+s(a)+m(c)},c,"The document could not be retrieved",f)},saveDoc:function(a,c){c=c||{};var f=this,h=u(c);if(a._id===undefined)var j="POST",n=this.uri;else{j="PUT";n=this.uri+s(a._id)}var o=e(a);g.ajax({type:j,url:n+m(c),contentType:"application/json",dataType:"json",data:p(a),
beforeSend:h,complete:function(q){var l=r(q,"json");if(q.status==200||q.status==201||q.status==202){a._id=l.id;a._rev=l.rev;if(o)f.openDoc(a._id,{attachPrevRev:true,success:function(w){a._attachments=w._attachments;c.success&&c.success(l)}});else c.success&&c.success(l)}else c.error?c.error(q.status,l.error,l.reason):alert("The document could not be saved: "+l.reason)}})},bulkSave:function(a,c){var f=u(c);g.extend(c,{successStatus:201,beforeSend:f});k({type:"POST",url:this.uri+"_bulk_docs"+m(c),contentType:"application/json",
data:p(a)},c,"The documents could not be saved")},removeDoc:function(a,c){k({type:"DELETE",url:this.uri+s(a._id)+m({rev:a._rev})},c,"The document could not be deleted")},bulkRemove:function(a,c){a.docs=g.each(a.docs,function(f,h){h._deleted=true});g.extend(c,{successStatus:201});k({type:"POST",url:this.uri+"_bulk_docs"+m(c),data:p(a)},c,"The documents could not be deleted")},copyDoc:function(a,c,f){f=g.extend(f,{complete:function(h){var j=r(h,"json");if(h.status==201)c.success&&c.success(j);else c.error?
c.error(h.status,j.error,j.reason):alert("The document could not be copied: "+j.reason)}});k({type:"COPY",url:this.uri+s(a)},c,"The document could not be copied",f)},query:function(a,c,f,h){f=f||"javascript";if(typeof a!=="string")a=a.toSource?a.toSource():"("+a.toString()+")";a={language:f,map:a};if(c!=null){if(typeof c!=="string")c=c.toSource?c.toSource():"("+c.toString()+")";a.reduce=c}k({type:"POST",url:this.uri+"_temp_view"+m(h),contentType:"application/json",data:p(a)},h,"An error occurred querying the database")},
list:function(a,c,f){a=a.split("/");f=f||{};var h="GET",j=null;if(f.keys){h="POST";j=f.keys;delete f.keys;j=p({keys:j})}k({type:h,data:j,url:this.uri+"_design/"+a[0]+"/_list/"+a[1]+"/"+c+m(f)},f,"An error occured accessing the list")},view:function(a,c){a=a.split("/");c=c||{};var f="GET",h=null;if(c.keys){f="POST";h=c.keys;delete c.keys;h=p({keys:h})}k({type:f,data:h,url:this.uri+"_design/"+a[0]+"/_view/"+a[1]+m(c)},c,"An error occurred accessing the view")},getDbProperty:function(a,c,f){k({url:this.uri+
a+m(c)},c,"The property could not be retrieved",f)},setDbProperty:function(a,c,f,h){k({type:"PUT",url:this.uri+a+m(f),data:JSON.stringify(c)},f,"The property could not be updated",h)}}},encodeDocId:s,info:function(b){k({url:this.urlPrefix+"/"},b,"Server information could not be retrieved")},replicate:function(b,d,e,i){i=g.extend({source:b,target:d},i);if(i.continuous)e.successStatus=202;k({type:"POST",url:this.urlPrefix+"/_replicate",data:JSON.stringify(i),contentType:"application/json"},e,"Replication failed")},
newUUID:function(b){if(b===undefined)b=1;t.length||k({url:this.urlPrefix+"/_uuids",data:{count:b},async:false},{success:function(d){t=d.uuids}},"Failed to retrieve UUID batch.");return t.shift()}});var r=g.httpData||function(b,d,e){var i=b.getResponseHeader("content-type")||"",a=d==="xml"||!d&&i.indexOf("xml")>=0;b=a?b.responseXML:b.responseText;a&&b.documentElement.nodeName==="parsererror"&&g.error("parsererror");if(e&&e.dataFilter)b=e.dataFilter(b,d);if(typeof b==="string")if(d==="json"||!d&&i.indexOf("json")>=
0)b=g.parseJSON(b);else if(d==="script"||!d&&i.indexOf("javascript")>=0)g.globalEval(b);return b}})(jQuery);